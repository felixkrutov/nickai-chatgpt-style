(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[332],{2829:(e,t,s)=>{"use strict";s.d(t,{N:()=>a});let a=(0,s(6879).UU)("https://wsfchumuttchudmdzwqj.supabase.co","eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndzZmNodW11dHRjaHVkbWR6d3FqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDQ1NDU1MzksImV4cCI6MjA2MDEyMTUzOX0.a5duFz3_7xWvbOGt85zI1l_3GcpDR0aQaI8J_sS4-2A")},2936:(e,t,s)=>{(window.__NEXT_P=window.__NEXT_P||[]).push(["/",function(){return s(5478)}])},5478:(e,t,s)=>{"use strict";s.r(t),s.d(t,{default:()=>h});var a=s(7876),n=s(4232),l=s(9099),i=s(2829),c=s(8761);function r(e){let{userEmail:t,chats:s=[],currentId:l,onNew:i,onSelect:r,onRename:o,onDelete:d,onLogout:u,onSettings:m}=e,[h,f]=(0,n.useState)(null),[x,g]=(0,n.useState)(""),p=e=>{f(e.id),g(e.title)},N=e=>{o(e.id,x.trim()||"Без названия"),f(null)},b=t===c.v;return(0,a.jsxs)("aside",{className:"w-64 bg-gray-800 p-4 flex flex-col",children:[(0,a.jsx)("h2",{className:"text-lg font-semibold mb-4",children:"Nick\xa0AI"}),(0,a.jsx)("button",{onClick:i,className:"mb-4 w-full px-3 py-2 bg-gray-700 hover:bg-gray-600 rounded text-sm",children:"+ Новый чат"}),(0,a.jsx)("div",{className:"flex-1 overflow-y-auto space-y-2 text-sm",children:s.map(e=>(0,a.jsx)("div",{className:"group px-2 py-1 rounded cursor-pointer ".concat(e.id===l?"bg-gray-700":"hover:bg-gray-700"),children:h===e.id?(0,a.jsx)("input",{className:"w-full bg-gray-600 px-1 rounded",value:x,onChange:e=>g(e.target.value),onBlur:()=>N(e),onKeyDown:t=>"Enter"===t.key&&N(e),autoFocus:!0}):(0,a.jsxs)("div",{onClick:()=>r(e.id),className:"flex justify-between items-center",children:[(0,a.jsx)("span",{className:"truncate",children:e.title}),(0,a.jsxs)("span",{className:"opacity-0 group-hover:opacity-100 space-x-1",children:[(0,a.jsx)("button",{onClick:()=>p(e),children:"✏️"}),(0,a.jsx)("button",{onClick:()=>d(e.id),children:"\uD83D\uDDD1"})]})]})},e.id))}),b&&(0,a.jsx)("button",{onClick:m,className:"mt-4 w-full px-3 py-2 bg-indigo-600 hover:bg-indigo-500 rounded text-sm",children:"⚙️\xa0Настройки"}),(0,a.jsx)("button",{onClick:u,className:"mt-2 w-full px-3 py-2 bg-red-600 hover:bg-red-500 rounded text-sm",children:"Выйти"})]})}function o(e){let{role:t,content:s}=e,n="user"===t,l=n?"justify-end text-right":"justify-start text-left",i=n?"bg-indigo-600":"bg-gray-700",c=n?"bg-indigo-500":"bg-teal-600",r=n?"\uD83D\uDE42":"\uD83E\uDD16";return(0,a.jsxs)("div",{className:"flex ".concat(l," mb-4"),children:[!n&&(0,a.jsx)("div",{className:"w-8 h-8 ".concat(c," rounded-full flex items-center justify-center mr-2"),children:r}),(0,a.jsx)("div",{className:"px-4 py-2 rounded-lg max-w-xs md:max-w-md ".concat(i),children:s}),n&&(0,a.jsx)("div",{className:"w-8 h-8 ".concat(c," rounded-full flex items-center justify-center ml-2"),children:r})]})}function d(e){let{onSend:t,disabled:s}=e,[l,i]=(0,n.useState)(""),c=(0,n.useRef)(null);return(0,n.useEffect)(()=>{var e;null==(e=c.current)||e.focus()},[s]),(0,a.jsxs)("form",{onSubmit:e=>{var s;e.preventDefault(),l.trim()&&(t(l.trim()),i(""),null==(s=c.current)||s.focus())},className:"bg-gray-800 p-4 flex",children:[(0,a.jsx)("input",{ref:c,value:l,onChange:e=>i(e.target.value),placeholder:"Введите сообщение...",className:"flex-1 px-3 py-2 bg-gray-700 rounded-l focus:outline-none",disabled:s}),(0,a.jsx)("button",{type:"submit",className:"px-4 py-2 bg-indigo-600 hover:bg-indigo-500 rounded-r text-white disabled:opacity-50",disabled:s,children:"➤"})]})}function u(e){let{userEmail:t,chats:s,currentId:l,onNewChat:i,onSelectChat:c,onRenameChat:u,onDeleteChat:m,onLogout:h,onSettings:f,messages:x,onSendMessage:g,loading:p}=e,N=(0,n.useRef)(null);return(0,n.useEffect)(()=>{var e;null==(e=N.current)||e.scrollIntoView({behavior:"smooth"})},[x]),(0,a.jsxs)("div",{className:"flex h-full",children:[(0,a.jsx)(r,{userEmail:t,chats:s,currentId:l,onNew:i,onSelect:c,onRename:u,onDelete:m,onLogout:h,onSettings:f}),(0,a.jsxs)("main",{className:"flex-1 flex flex-col",children:[(0,a.jsxs)("div",{className:"flex-1 overflow-y-auto p-6",children:[x.map((e,t)=>(0,a.jsx)(o,{role:e.role,content:e.content},t)),p&&(0,a.jsx)("p",{className:"text-gray-400 text-sm",children:"Nick\xa0AI печатает…"}),(0,a.jsx)("div",{ref:N})]}),(0,a.jsx)(d,{onSend:g,disabled:p})]})]})}let m=e=>{let t="Новый чат",s=/^Новый чат(?: (\d+))?$/,a=-1;return e.forEach(e=>{let t=e.title.match(s);if(t){let e=t[1]?parseInt(t[1],10):0;e>a&&(a=e)}}),-1===a?t:"".concat(t," ").concat(a+1)};function h(){let e=(0,l.useRouter)(),[t,s]=(0,n.useState)(null),[c,r]=(0,n.useState)([]),[o,d]=(0,n.useState)(null),[h,f]=(0,n.useState)([]),[x,g]=(0,n.useState)(!1);(0,n.useEffect)(()=>{i.N.auth.getUser().then(t=>{let{data:{user:a}}=t;a?(s(a),p(a.id)):e.replace("/login")})},[e]);let p=async e=>{let{data:t}=await i.N.from("chats").select("*").eq("user_id",e).order("created_at");r(t||[]),(null==t?void 0:t[0])&&N(t[0].id)},N=async e=>{d(e);let{data:t}=await i.N.from("messages").select("*").eq("chat_id",e).order("created_at");f(t||[])},b=async()=>{let e=m(c),{data:s}=await i.N.from("chats").insert({user_id:t.id,title:e}).select().single();r(e=>[...e,s]),f([]),d(s.id)},y=async(e,t)=>{await i.N.from("chats").update({title:t}).eq("id",e),r(s=>s.map(s=>s.id===e?{...s,title:t}:s))},j=async e=>{await i.N.from("chats").delete().eq("id",e);let t=c.filter(t=>t.id!==e);r(t),t[0]?N(t[0].id):(d(null),f([]))},w=async e=>{let s=o;if(!s){let e=m(c),{data:a}=await i.N.from("chats").insert({user_id:t.id,title:e}).select().single();r(e=>[...e,a]),d(s=a.id)}let a={role:"user",content:e},n={role:"assistant",content:"..."};f(e=>[...e,a,n]),g(!0),await i.N.from("messages").insert({chat_id:s,...a});let l=await fetch("/api/chat",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({messages:[...h,a].slice(-50)})}),{assistant:u,error:x}=await l.json(),p={role:"assistant",content:u||"Ошибка: ".concat(x)};await i.N.from("messages").insert({chat_id:s,...p}),f(e=>[...e.slice(0,-1),p]),g(!1)},v=async()=>{await i.N.auth.signOut(),e.replace("/login")};return t?(0,a.jsx)(u,{userEmail:t.email,chats:c,currentId:o,onNewChat:b,onSelectChat:N,onRenameChat:y,onDeleteChat:j,onLogout:v,onSettings:()=>e.push("/admin"),messages:h.length?h:[{role:"assistant",content:"Привет!\xa0Я\xa0Nick\xa0AI. Чем могу помочь?"}],onSendMessage:w,loading:x}):null}},8761:(e,t,s)=>{"use strict";s.d(t,{v:()=>a});let a="googoldecaplex@bk.ru"}},e=>{var t=t=>e(e.s=t);e.O(0,[721,636,593,792],()=>t(2936)),_N_E=e.O()}]);